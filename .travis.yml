language: ruby
sudo: false
cache:
  bundler: true
  directories:
    - node_modules
rvm:
  - "2.6.5"
services:
  - memcached
  - postgresql
  - redis-server
addons:
  chrome: stable
  postgresql: "9.6"
env:
  - RAILS_ENV=test NODE_ENV=test SECRET_KEY_BASE=0af8c0e49e9259f2d777cfcd121d8540cee914c34b0abf08dd825bdee47c402daf9f2b9b74a9fff6f88ed95257ae39504e0d59c66400413b0cf7d29079c6358b
before_install:
  - . $HOME/.nvm/nvm.sh
  - nvm install 12.13.0
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.19.1
  - export PATH="$HOME/.yarn/bin:$PATH"
  - CHROMEDRIVER_VERSION=$(wget -qO- https://chromedriver.storage.googleapis.com/LATEST_RELEASE)
  - curl -o tmp/chromedriver.zip https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip
  - unzip -d "$HOME/bin/" tmp/chromedriver.zip
script:
  - ruby --version && [ "$(ruby --version | cut -c1-11)" == 'ruby 2.6.5p' ]
  - bundle --version && [ "$(bundle --version | cut -c1-20)" == 'Bundler version 2.1.' ]
  - node --version && [ "$(node --version)" == 'v12.13.0' ]
  - yarn --version && [ "$(yarn --version)" == '1.19.1' ]
  - chromedriver --version # print chromedriver version, but don't check it, because it changes
  - yarn install
  - bin/rails spec:setup_js > /dev/null 2>&1 &
  - bundle exec rubocop $(git ls-tree -r HEAD --name-only) --force-exclusion --format clang
  - bundle exec brakeman --quiet
  - bundle exec fasterer
  - ./node_modules/.bin/stylelint app/**/*.{css,scss,vue} --max-warnings 0
  - bin/rails db:create
  - bin/rails db:schema:load
  - bin/rails spec:fixture_builder:rebuild
  - bin/rails spec:poll_js
  - ./node_modules/.bin/eslint --max-warnings 0 --ext .js,.vue app/javascript/ spec/javascript/
  - bin/rails spec:run_js
  - bin/rails spec:rb
notifications:
  email:
    on_success: never
    on_failure: always
deploy:
  provider: heroku
  # This token will expire 2021-02-16.
  # To make a new one, see: https://docs.travis-ci.com/user/deployment/heroku/
  api_key:
    secure: Lm2PkMO/VUeBIIYosIAUKbxS5jTtU9JrGVXPNxXNsCRlBTKjoQgV8VHLV4uE0hhn5F1kYCH0qkJRxzHK0nQ0ZVQaUyYam96Lu9HUBq64mSXF2NzpJLDQpS3Rw4cQVywv5F2FFzdiK39UHTUfxevCCgf3KJVlEz2vcuM1dKXNzWnB9a3051uSjPVaVxxbrLmr+P54rf47wG/GQEiYK1Dd3/mx7AGzJjVVh0/TPc/OoZcdjHWD/76l50jAjTl3V+pDCcJqRwY9aqSgRxJjlBC8SaMpJrGZ2dVAf5caRFZsLpxoAIRYOQOjksw9SQQmUEjGdVTuVMweYS57JKcZiC2/Bps/TflmdXemmS38O6zWNMpmh8Wwainfl9bO0kYntBvFKbMVA8+3zBlPtuWRzFpjHuxknk6g/5ipNEuxBOBNLyM1w7I0DemYyTbOZd+GY34OOS3cIoVgYN3+lXqPjbQlmLeyZzxoYiCEV177Yj2cPcN+rsEdinoLtmnqdMO/WvubKTiqlY+Iqvu526kqYCYtLxJBXUP4PkaIuBo2gjyuJGavTaLdIETM8evW2MjiVRF1d70edMpEp5zeKcN0mj8RWa88ik359MmuRr9ZNMHoLmGr/0gTymPmDMRRGQcMdHfZLGrxU8y+DovhSTpclCbwMiv1/BZ1grqSnPJ6aJTKw7w=
  strategy: git
  app: davidrunger
