#!/usr/bin/env ruby

# https://stackoverflow.com/a/77655338/4009384
if !defined?(Rails)
  exec('bin/rails', 'runner', __FILE__, *ARGV)
end

class Runner
  def run_task(task_description)
    print("#{task_description}... ")
    start_time = Time.current
    yield
    puts("done. (Took #{(Time.current - start_time).round(2)} seconds.)")
  end

  def with_modified_env(env_modifications)
    original_env_values = {}

    env_modifications.each do |env_var, new_value|
      original_env_values[env_var] = ENV.fetch(env_var, nil)
      ENV[env_var] = new_value
    end

    yield
  ensure
    original_env_values.each do |env_var, original_value|
      ENV[env_var] = original_value
    end
  end
end

runner = Runner.new

runner.run_task('Running db:migrate') do
  Rails.application.load_tasks

  (1..10).each do |attempt_number|
    print("attempt ##{attempt_number}... ")
    Rake::Task['db:migrate'].invoke
  rescue => error
    pp(error)
    sleep(attempt_number)
  else
    break
  end
end

runner.run_task('Recording asset sizes') do
  TrackAssetSizes.new.perform
end

runner.run_task('Creating a `Deploy`') do
  Deploy.create!(git_sha: ENV.fetch('GIT_REV'))
end

runner.run_task('Registering deploy with Sidekiq') do
  runner.with_modified_env('REDIS_URL' => RedisOptions.new(db: 1).url) do
    require 'sidekiq/deploy'
    Sidekiq::Deploy.mark!(ENV.fetch('GIT_REV').first(7))
  end
end

runner.run_task('Notifying Rollbar of deploy') do
  access_token = Rails.application.credentials.rollbar!.access_token!
  Faraday.json_connection.post(
    'https://api.rollbar.com/api/1/deploy/',
    {
      'environment' => Rails.env,
      'revision' => ENV.fetch('GIT_REV'),
      'rollbar_username' => 'davidjrunger',
    },
    {
      'X-Rollbar-Access-Token' => access_token,
    },
  )
end
