#!/usr/bin/env bash

# Run Stylelint.

set -euo pipefail # exit on any error, don't allow undefined variables, pipes don't swallow errors

files_for_stylelint=$(
  changed-not-deleted-files | \
    rg "app/.*\.(css|scss|vue)$" || \
    true
)

git_diff_hash_before=$(git diff | sha1sum | choose 0)

if [[ $files_for_stylelint != "" ]]; then
  set +e
  (
    set -x
    ./node_modules/.bin/stylelint --max-warnings 0 --fix $files_for_stylelint
  )
  stylelint_status=$?
  set -e

  if [ $stylelint_status -eq 0 ]; then
    git_diff_hash_after=$(git diff | sha1sum | choose 0)

    if [ "$git_diff_hash_before" == "$git_diff_hash_after" ] ; then
      echo 'Stylelint passed.'
    else
      blue 'There were Stylelint violation(s). They were all autocorrected.'
      exit 1
    fi
  else
    red 'There were Stylelint error(s) that could not be autocorrected.'
    exit 1
  fi
else
  echo 'No files need to be linted by Stylelint.'
fi
