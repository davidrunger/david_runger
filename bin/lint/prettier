#!/usr/bin/env bash

# Run Prettier.

set -euo pipefail # exit on any error, don't allow undefined variables, pipes don't swallow errors

# Every file must have a period somewhere (either a dotfile or file extension).
# Ruby files aren't linted by Prettier.
files_for_prettier=$(
  changed-not-deleted-files | \
    rg '\.' | \
    rg -v '\.(haml|lock|rb)$' || \
    true
)

if [[ $files_for_prettier != "" ]]; then
  set +e
  (
    set -x
    prettier --check --ignore-unknown $files_for_prettier
  )
  prettier_status=$?
  set -e

  if [ $prettier_status -eq 0 ]; then
    : # (Prettier printed a success message, so we don't need to do so here.)
  else
    set +e
    files_to_autocorrect=$(prettier --list-different $files_for_prettier)
    set -e

    set -x
    prettier --write $files_to_autocorrect
    { set +x; } 2>/dev/null

    blue "Autocorrected:"
    echo "$files_to_autocorrect" | tr ' ' '\n' | blue

    exit 1
  fi
else
  echo 'No files need to be linted by Prettier.'
fi
