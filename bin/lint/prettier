#!/usr/bin/env bash

# Run Prettier.

set -euo pipefail # exit on any error, don't allow undefined variables, pipes don't swallow errors

# Every file must have a period somewhere (either a dotfile or file extension).
# Ruby files aren't linted by Prettier.
files_for_prettier=$(
  changed-not-deleted-files | \
    rg '\.' | \
    rg -v '\.(haml|lock|rb)$' || \
    true
)

git_diff_hash_before=$(git diff | sha1sum | choose 0)

if [[ $files_for_prettier != "" ]]; then
  set +e
  (
    set -x
    ./node_modules/.bin/prettier --write --log-level=error $files_for_prettier
  )
  prettier_status=$?
  set -e

  git_diff_hash_after=$(git diff | sha1sum | choose 0)

  if [ "$git_diff_hash_before" == "$git_diff_hash_after" ] ; then
    echo 'All files are Prettier-compliant.'
  else
    blue 'There were Prettier violation(s). They were all corrected.'
    exit 1
  fi
else
  echo 'No files need to be linted by Prettier.'
fi
