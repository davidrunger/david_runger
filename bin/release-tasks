#!/usr/bin/env ruby
# frozen_string_literal: true

if !defined?(Rails)
  exec(
    File.expand_path('rails', __dir__),
    'runner',
    File.expand_path(__FILE__),
  )
end

class Runner
  def run_task(task_description)
    print("#{task_description}... ")
    start_time = Time.current
    yield
    puts("done. (Took #{(Time.current - start_time).round(2)} seconds.)")
  end
end

runner = Runner.new

runner.run_task('Running db:migrate') do
  Rails.application.load_tasks

  (1..10).each do |attempt_number|
    print("attempt ##{attempt_number}...")
    Rake::Task['db:migrate'].invoke
  rescue => error
    pp(error)
    sleep(attempt_number)
  else
    break
  end
end

runner.run_task('Recording asset sizes') do
  TrackAssetSizes.new.perform
end

runner.run_task('Creating a `Deploy`') do
  Deploy.create!(git_sha: ENV.fetch('GIT_REV'))
end
